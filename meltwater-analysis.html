<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Meltwater Value Analysis - HSG Dashboard</title>
  <style>
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      background:#fafbfc;
      min-height:100vh;
      color:#1a1a1a;
    }
    header{
      background:#4a6741;
      color:#fff;
    }
    .header-content{
      max-width:1200px;
      margin:0 auto;
      padding:20px 32px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .header-title{
      margin:0;
      font-size:32px;
      font-weight:700;
      letter-spacing:-.02em;
    }
    .back-btn{
      background:rgba(255,255,255,.2);
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
      text-decoration:none;
      display:inline-block;
    }
    .back-btn:hover{
      background:rgba(255,255,255,.3);
      transform:translateY(-1px);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:32px 24px;
    }

    .controls{
      background:#fff;
      border-radius:16px;
      padding:20px;
      margin-bottom:24px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      gap:16px;
    }
    .controls label{
      font-weight:600;
      color:#333;
    }
    .controls select{
      padding:10px 16px;
      border:2px solid #e0e0e0;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
    }
    .controls button{
      background:#4a6741;
      color:#fff;
      border:none;
      padding:10px 24px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      transition:.3s;
    }
    .controls button:hover{
      background:#5a7c50;
      transform:translateY(-1px);
    }

    .verdict-card{
      background:#fff;
      border-radius:16px;
      padding:32px;
      margin-bottom:24px;
      box-shadow:0 4px 20px rgba(0,0,0,.12);
      text-align:center;
      border:3px solid;
    }
    .verdict-card.high-value{
      border-color:#4caf50;
      background:linear-gradient(135deg, #fff 0%, #f1f8f4 100%);
    }
    .verdict-card.moderate-value{
      border-color:#ff9800;
      background:linear-gradient(135deg, #fff 0%, #fff8f1 100%);
    }
    .verdict-card.low-value{
      border-color:#f44336;
      background:linear-gradient(135deg, #fff 0%, #fff1f0 100%);
    }
    .verdict-card.uncertain{
      border-color:#9e9e9e;
      background:linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
    }
    .verdict-title{
      font-size:36px;
      font-weight:700;
      margin:0 0 16px 0;
      letter-spacing:-.02em;
    }
    .verdict-reason{
      font-size:18px;
      color:#333;
      line-height:1.6;
      margin:0;
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:20px;
      margin-bottom:24px;
    }
    .stat-card{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      border-left:4px solid #8bc34a;
    }
    .stat-label{
      font-size:13px;
      color:#666;
      text-transform:uppercase;
      font-weight:600;
      letter-spacing:.5px;
      margin:0 0 8px 0;
    }
    .stat-value{
      font-size:32px;
      font-weight:700;
      color:#1a1a1a;
      margin:0;
    }
    .stat-subtext{
      font-size:12px;
      color:#999;
      margin:4px 0 0 0;
    }

    .chart-container{
      background:#fff;
      border-radius:16px;
      padding:24px;
      margin-bottom:24px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .chart-title{
      font-size:18px;
      font-weight:700;
      color:#1a1a1a;
      margin:0 0 20px 0;
    }
    .bar-chart{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .bar-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .bar-label{
      width:120px;
      font-size:13px;
      font-weight:600;
      color:#333;
    }
    .bar-track{
      flex:1;
      height:32px;
      background:#f0f0f0;
      border-radius:8px;
      overflow:hidden;
      position:relative;
    }
    .bar-fill{
      height:100%;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding:0 12px;
      color:#fff;
      font-weight:700;
      font-size:13px;
      transition:width .3s;
    }
    .bar-fill.unique{background:#4caf50}
    .bar-fill.similar{background:#ff9800}
    .bar-fill.duplicate{background:#f44336}

    .examples-section{
      background:#fff;
      border-radius:16px;
      padding:24px;
      margin-bottom:24px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .examples-title{
      font-size:18px;
      font-weight:700;
      color:#1a1a1a;
      margin:0 0 20px 0;
    }
    .example-card{
      background:#f8f9fa;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      border-left:4px solid #8bc34a;
    }
    .example-title{
      font-size:14px;
      font-weight:700;
      color:#1a1a1a;
      margin:0 0 8px 0;
    }
    .example-meta{
      font-size:12px;
      color:#666;
      margin:4px 0;
    }
    .example-link{
      color:#4a6741;
      text-decoration:none;
      font-size:12px;
      font-weight:600;
    }
    .example-link:hover{
      text-decoration:underline;
    }

    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:60px;
      color:#666;
      font-size:18px;
    }
    .loading::before{
      content:'';
      width:24px;
      height:24px;
      border:3px solid rgba(139,195,74,.3);
      border-top:3px solid #8bc34a;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-right:12px;
    }
    @keyframes spin{
      0%{transform:rotate(0)}
      100%{transform:rotate(360deg)}
    }

    .domain-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .domain-tag{
      background:#e8f5e9;
      color:#2e7d32;
      padding:6px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }

    .comparison-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
      gap:20px;
      margin-top:24px;
    }
    .comparison-card{
      background:#f8f9fa;
      border-radius:12px;
      padding:20px;
      border:2px solid #e0e0e0;
    }
    .comparison-title{
      font-size:16px;
      font-weight:700;
      color:#1a1a1a;
      margin:0 0 16px 0;
    }
    .comparison-stat{
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
      font-size:14px;
    }
    .comparison-stat-label{
      color:#666;
    }
    .comparison-stat-value{
      font-weight:700;
      color:#1a1a1a;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <h1 class="header-title">üìä Meltwater Value Analysis</h1>
      <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <label for="days-select">Analysis Period:</label>
      <select id="days-select">
        <option value="3">Last 3 Days</option>
        <option value="7" selected>Last 7 Days</option>
        <option value="14">Last 14 Days</option>
        <option value="30">Last 30 Days</option>
      </select>
      <button onclick="runAnalysis()">üîÑ Refresh Analysis</button>
    </div>

    <div id="loading" class="loading" style="display:none">Running analysis...</div>
    <div id="results"></div>
  </div>

  <script>
    async function runAnalysis() {
      const days = document.getElementById('days-select').value;
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');

      try {
        loading.style.display = 'flex';
        results.innerHTML = '';

        const res = await fetch(`/api/meltwater_analysis?days=${days}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        loading.style.display = 'none';

        if (!data.ok) {
          throw new Error(data.error || 'Analysis failed');
        }

        displayResults(data);

      } catch (error) {
        loading.style.display = 'none';
        results.innerHTML = `
          <div class="verdict-card uncertain">
            <h2 class="verdict-title">‚ùå Error</h2>
            <p class="verdict-reason">${error.message}</p>
          </div>`;
        console.error('Analysis error:', error);
      }
    }

    function displayResults(data) {
      const results = document.getElementById('results');
      const rec = data.recommendation;
      const analysis = data.overall_analysis;

      // Verdict styling
      let verdictClass = 'uncertain';
      if (rec.verdict === 'HIGH VALUE') verdictClass = 'high-value';
      else if (rec.verdict === 'MODERATE VALUE') verdictClass = 'moderate-value';
      else if (rec.verdict === 'LOW VALUE') verdictClass = 'low-value';

      let verdictIcon = '‚ùì';
      if (rec.verdict === 'HIGH VALUE') verdictIcon = '‚úÖ';
      else if (rec.verdict === 'MODERATE VALUE') verdictIcon = '‚ö†Ô∏è';
      else if (rec.verdict === 'LOW VALUE') verdictIcon = '‚ùå';

      results.innerHTML = `
        <!-- Verdict Card -->
        <div class="verdict-card ${verdictClass}">
          <h2 class="verdict-title">${verdictIcon} ${rec.verdict}</h2>
          <p class="verdict-reason">${rec.reason}</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <p class="stat-label">Unique Content</p>
            <p class="stat-value">${analysis.uniqueness_percentage}%</p>
            <p class="stat-subtext">${analysis.unique_content} of ${analysis.total_meltwater} articles</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Duplicate Content</p>
            <p class="stat-value">${analysis.duplicate_percentage}%</p>
            <p class="stat-subtext">${analysis.duplicate_content} of ${analysis.total_meltwater} articles</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Similar Content</p>
            <p class="stat-value">${analysis.similar_percentage}%</p>
            <p class="stat-subtext">${analysis.similar_content} of ${analysis.total_meltwater} articles</p>
          </div>
          <div class="stat-card">
            <p class="stat-label">Exclusive Sources</p>
            <p class="stat-value">${analysis.unique_sources}</p>
            <p class="stat-subtext">Domains only in Meltwater</p>
          </div>
        </div>

        <!-- Bar Chart -->
        <div class="chart-container">
          <h3 class="chart-title">Content Distribution</h3>
          <div class="bar-chart">
            <div class="bar-row">
              <div class="bar-label">Unique</div>
              <div class="bar-track">
                <div class="bar-fill unique" style="width:${analysis.uniqueness_percentage}%">
                  ${analysis.uniqueness_percentage}%
                </div>
              </div>
            </div>
            <div class="bar-row">
              <div class="bar-label">Similar</div>
              <div class="bar-track">
                <div class="bar-fill similar" style="width:${analysis.similar_percentage}%">
                  ${analysis.similar_percentage}%
                </div>
              </div>
            </div>
            <div class="bar-row">
              <div class="bar-label">Duplicate</div>
              <div class="bar-track">
                <div class="bar-fill duplicate" style="width:${analysis.duplicate_percentage}%">
                  ${analysis.duplicate_percentage}%
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparison Breakdowns -->
        <div class="chart-container">
          <h3 class="chart-title">Comparison Breakdowns</h3>
          <div class="comparison-grid">
            <div class="comparison-card">
              <h4 class="comparison-title">vs Google Alerts</h4>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Unique:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_google_alerts.unique_percentage}%</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Duplicate:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_google_alerts.duplicate_percentage}%</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Exclusive Sources:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_google_alerts.unique_sources}</span>
              </div>
            </div>
            <div class="comparison-card">
              <h4 class="comparison-title">vs Newsletters</h4>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Unique:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_newsletters.unique_percentage}%</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Duplicate:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_newsletters.duplicate_percentage}%</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Exclusive Sources:</span>
                <span class="comparison-stat-value">${data.comparison_breakdowns.vs_newsletters.unique_sources}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Unique Meltwater Articles -->
        ${analysis.unique_meltwater_articles.length > 0 ? `
          <div class="examples-section">
            <h3 class="examples-title">Example Unique Meltwater Articles (Top 10)</h3>
            ${analysis.unique_meltwater_articles.map(article => `
              <div class="example-card">
                <h4 class="example-title">${escapeHtml(article.title)}</h4>
                <p class="example-meta">Publisher: ${escapeHtml(article.publisher || 'Unknown')} | Date: ${new Date(article.date).toLocaleDateString()}</p>
                <p class="example-meta">${escapeHtml(article.summary || '')}</p>
                ${article.link ? `<a href="${article.link}" target="_blank" class="example-link">Read Article ‚Üí</a>` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}

        <!-- Duplicate Examples -->
        ${analysis.duplicate_examples.length > 0 ? `
          <div class="examples-section">
            <h3 class="examples-title">Example Duplicate Content</h3>
            ${analysis.duplicate_examples.map(dup => `
              <div class="example-card">
                <h4 class="example-title">Meltwater: ${escapeHtml(dup.meltwater.title)}</h4>
                <p class="example-meta">
                  ${dup.similarity}% similar to ${dup.matched_with.origin}:
                  <strong>${escapeHtml(dup.matched_with.title)}</strong>
                </p>
                ${dup.meltwater.link ? `<a href="${dup.meltwater.link}" target="_blank" class="example-link">Meltwater Link ‚Üí</a>` : ''}
                ${dup.matched_with.link ? `<a href="${dup.matched_with.link}" target="_blank" class="example-link" style="margin-left:12px">Matched Link ‚Üí</a>` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}

        <!-- Exclusive Domains -->
        ${analysis.meltwater_only_domains.length > 0 ? `
          <div class="examples-section">
            <h3 class="examples-title">Exclusive Meltwater Sources (${analysis.meltwater_only_domains.length} domains)</h3>
            <div class="domain-list">
              ${analysis.meltwater_only_domains.slice(0, 20).map(domain => `
                <span class="domain-tag">${escapeHtml(domain)}</span>
              `).join('')}
              ${analysis.meltwater_only_domains.length > 20 ? `
                <span class="domain-tag">+ ${analysis.meltwater_only_domains.length - 20} more</span>
              ` : ''}
            </div>
          </div>
        ` : ''}

        <!-- Article Counts -->
        <div class="chart-container">
          <h3 class="chart-title">Article Counts (Last ${document.getElementById('days-select').value} Days)</h3>
          <div class="comparison-grid">
            <div class="comparison-card">
              <h4 class="comparison-title">Sources</h4>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Meltwater:</span>
                <span class="comparison-stat-value">${data.article_counts.meltwater}</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Google Alerts:</span>
                <span class="comparison-stat-value">${data.article_counts.google_alerts}</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Newsletters:</span>
                <span class="comparison-stat-value">${data.article_counts.newsletters}</span>
              </div>
              <div class="comparison-stat">
                <span class="comparison-stat-label">Other:</span>
                <span class="comparison-stat-value">${data.article_counts.other}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Run analysis on page load
    runAnalysis();
  </script>

</body>
</html>
