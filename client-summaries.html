<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Client Summaries - HSG Dashboard</title>
  <style>
    *{box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;
      background:linear-gradient(135deg,#f8fffe 0%,#f1f8f6 100%);
      min-height:100vh;color:#1a1a1a
    }
    header{
      background:linear-gradient(135deg,#4a6741 0%,#5a7c50 100%);
      color:#fff;padding:24px 32px;box-shadow:0 4px 20px rgba(74,103,65,.15);
      position:relative;overflow:hidden
    }
    header::before{
      content:'';position:absolute;inset:0;
      background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>')
    }
    .header-content{position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between}
    .header-title{margin:0;font-size:28px;font-weight:600;letter-spacing:-.02em}
    .back-btn{background:rgba(255,255,255,.2);color:#fff;border:none;padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:.3s;text-decoration:none;display:inline-block}
    .back-btn:hover{background:rgba(255,255,255,.3);transform:translateY(-1px)}

    .wrap{max-width:1200px;margin:0 auto;padding:32px 24px}
    .summary-card{background:#fff;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:24px;margin-bottom:20px;border:1px solid rgba(139,195,74,.2);transition:.3s;position:relative}
    .summary-card:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .summary-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,#8bc34a,#7cb342);border-radius:16px 16px 0 0}
    .summary-title{font-size:20px;font-weight:700;color:#1a1a1a;margin:0 0 16px 0;line-height:1.4}
    .summary-text{color:#333;font-size:15px;line-height:1.7;white-space:pre-wrap}
    .summary-meta{color:#666;font-size:13px;margin-top:16px;padding-top:16px;border-top:1px solid rgba(139,195,74,.2);display:flex;align-items:center;justify-content:space-between}
    .delete-btn{background:#d32f2f;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:.3s}
    .delete-btn:hover{background:#c62828;transform:translateY(-1px)}
    .copy-btn{background:#4a6741;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:.3s;margin-right:8px}
    .copy-btn:hover{background:#5a7c50;transform:translateY(-1px)}

    .empty-state{text-align:center;padding:60px 20px;color:#666;background:#fff;border-radius:16px;border:1px solid rgba(139,195,74,.2)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
    .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#666}
    .loading::before{content:'';width:20px;height:20px;border:2px solid rgba(139,195,74,.3);border-top:2px solid #8bc34a;border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .section-title{font-size:24px;font-weight:700;color:#1a1a1a;margin:0 0 24px 0;display:flex;align-items:center;gap:12px}
    .section-title::before{content:'';width:4px;height:24px;background:linear-gradient(135deg,#8bc34a,#7cb342);border-radius:2px}
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <h1 class="header-title">üìã Client Summaries</h1>
      <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
    </div>
  </header>

  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
      <h2 class="section-title" style="margin:0">Saved Client Summaries</h2>
      <button id="export-doc-btn" class="back-btn" style="background:#4a6741" onclick="exportToWord()">üìÑ Export to Word</button>
    </div>
    <div id="loading" class="loading">Loading summaries...</div>
    <div id="summaries-container"></div>
  </div>

  <!-- Load docx library for Word document generation -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
  <script>
    async function loadSummaries() {
      const loading = document.getElementById('loading');
      const container = document.getElementById('summaries-container');

      try {
        loading.style.display = 'flex';

        const res = await fetch('/api/client_summaries', { method: 'GET' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        loading.style.display = 'none';

        if (!data.summaries || data.summaries.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÑ</div>
              <h3>No client summaries yet</h3>
              <p>Use the "Client Summary" button on the main dashboard to create summaries.</p>
            </div>`;
          return;
        }

        container.innerHTML = data.summaries.map(summary => {
          const date = new Date(summary.created_at).toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          // Format the summary text
          let formattedSummary = summary.summary;

          // Remove brackets around title
          formattedSummary = formattedSummary.replace(/^\[([^\]]+)\]/, '$1');

          // Split into lines
          const lines = formattedSummary.split('\n').filter(line => line.trim());

          // Extract title (first line)
          const titleLine = lines[0].trim();

          // Get summary content (lines with "Summary:")
          const summaryContent = lines.filter(line => line.includes('Summary:')).join('\n');

          // Remove duplicate title if it appears again
          const cleanedLines = lines.filter((line, index) => {
            if (index === 0) return false; // Skip first line (title)
            if (line.trim() === titleLine) return false; // Skip duplicate title
            if (line.includes('Summary:')) return true; // Keep summary
            return line.length > 10; // Keep other substantial content
          });

          const escapeForHtml = (str) => str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `
            <div class="summary-card" data-id="${summary.id}">
              <h3 class="summary-title">${escapeForHtml(titleLine)}</h3>
              <div class="summary-text">${cleanedLines.map(l => escapeForHtml(l)).join('\n')}</div>
              <div class="summary-meta">
                <span>Created: ${date}</span>
                <div>
                  <button class="copy-btn" onclick="copySummary('${summary.id}')">üìã Copy</button>
                  <button class="delete-btn" onclick="deleteSummary('${summary.id}')">üóëÔ∏è Delete</button>
                </div>
              </div>
            </div>`;
        }).join('');

      } catch (error) {
        loading.style.display = 'none';
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Error loading summaries</h3>
            <p>${error.message}</p>
          </div>`;
        console.error('Error loading summaries:', error);
      }
    }

    async function deleteSummary(summaryId) {
      if (!confirm('Are you sure you want to delete this summary?')) {
        return;
      }

      try {
        const res = await fetch('/api/client_summaries', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ summary_id: summaryId })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        if (data.ok) {
          // Remove the card from the page
          const card = document.querySelector(`[data-id="${summaryId}"]`);
          if (card) {
            card.style.opacity = '0';
            card.style.transform = 'translateY(-20px)';
            setTimeout(() => {
              card.remove();
              // Check if there are any summaries left
              const container = document.getElementById('summaries-container');
              if (!container.querySelector('.summary-card')) {
                loadSummaries();
              }
            }, 300);
          }
        } else {
          alert(`Error: ${data.message || 'Failed to delete'}`);
        }
      } catch (error) {
        alert(`Error deleting summary: ${error.message}`);
      }
    }

    function copySummary(summaryId) {
      const card = document.querySelector(`[data-id="${summaryId}"]`);
      if (!card) return;

      const title = card.querySelector('.summary-title').textContent;
      const text = card.querySelector('.summary-text').textContent;
      const fullText = `${title}\n${text}`;

      navigator.clipboard.writeText(fullText).then(() => {
        const btn = card.querySelector('.copy-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = '#4caf50';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#4a6741';
        }, 2000);
      }).catch(err => {
        alert('Failed to copy: ' + err.message);
      });
    }

    async function exportToWord() {
      try {
        // Fetch summaries from API
        const res = await fetch('/api/client_summaries', { method: 'GET' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        if (!data.summaries || data.summaries.length === 0) {
          alert('No summaries to export');
          return;
        }

        // Build document sections
        const children = [];

        // Add document title
        children.push(
          new docx.Paragraph({
            text: "Client Summaries",
            heading: docx.HeadingLevel.TITLE,
            spacing: { after: 400 }
          })
        );

        // Add generation date
        const today = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        children.push(
          new docx.Paragraph({
            text: `Generated: ${today}`,
            spacing: { after: 400 }
          })
        );

        // Add each summary
        data.summaries.forEach((summary, index) => {
          // Format the summary text
          let formattedSummary = summary.summary;
          formattedSummary = formattedSummary.replace(/^\[([^\]]+)\]/, '$1');
          const lines = formattedSummary.split('\n').filter(line => line.trim());

          // Extract title (first line)
          const titleLine = lines[0].trim();

          // Get summary content (remove title, keep summary lines)
          const summaryLines = lines.filter((line, i) => {
            if (i === 0) return false; // Skip title
            if (line.trim() === titleLine) return false; // Skip duplicate title
            return line.length > 10; // Keep substantial content
          });

          // Add article title as heading
          children.push(
            new docx.Paragraph({
              text: titleLine,
              heading: docx.HeadingLevel.HEADING_2,
              spacing: { before: 400, after: 200 }
            })
          );

          // Add summary content
          summaryLines.forEach(line => {
            children.push(
              new docx.Paragraph({
                text: line,
                spacing: { after: 100 }
              })
            );
          });

          // Add spacing between summaries
          if (index < data.summaries.length - 1) {
            children.push(
              new docx.Paragraph({
                text: "",
                spacing: { after: 300 },
                border: {
                  bottom: {
                    color: "CCCCCC",
                    space: 1,
                    style: docx.BorderStyle.SINGLE,
                    size: 6
                  }
                }
              })
            );
          }
        });

        // Create document
        const doc = new docx.Document({
          sections: [{
            properties: {},
            children: children
          }]
        });

        // Generate and download
        const blob = await docx.Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;

        // Generate filename with current date
        const filename = `client-summaries-${new Date().toISOString().split('T')[0]}.docx`;
        link.download = filename;

        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Update button to show success
        const btn = document.getElementById('export-doc-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úì Exported!';
        btn.style.background = '#4caf50';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '#4a6741';
        }, 2000);

      } catch (error) {
        alert(`Error exporting to Word: ${error.message}`);
        console.error('Word export error:', error);
      }
    }

    // Load summaries on page load
    loadSummaries();
  </script>

</body>
</html>
